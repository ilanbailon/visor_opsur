<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Visor</title>

  <!-- CSS de librer√≠as -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pannellum@2.5.6/build/pannellum.css" />

  <!-- Tu CSS -->
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <header>
    <div><b>Visor Operadora Sur</b></div>
    <button id="btnOpenUploader" class="pill">üì¶ Subir grupo (CSV+ZIP)</button>
    <button id="btnMark" class="ghost">‚ûï Marcar punto</button>
    <button id="btnRecorrido" class="ghost">‚ñ∂ Recorrido</button>
    <div id="searchWrap">
      <input id="search" type="text" placeholder="Buscar: progresiva / nombre‚Ä¶" autocomplete="off" />
      <div id="suggest"></div>
    </div>
    <div class="status" id="status">Listo</div>
  </header>

  <div id="split">
    <section id="leftPane">
      <div id="map"></div>
      <div id="layersInfo"></div>
    </section>
    <div id="gutter" title="Arrastra para redimensionar"></div>
    <section id="rightPane">
      <div id="viewerHeader">
        <div id="viewerTitle">Visor</div>
        <div class="muted" id="viewerHint">Click en un punto o usa Recorrido</div>
      </div>

      <!-- Controles para RECORRIDO / 360 -->
      <div id="controlsRun">
        <div class="row">
          <label>Grupo</label>
          <select id="selGrupo"></select>
          <span class="chip" id="countPts">0 pts</span>
        </div>
        <div class="row">
          <button id="btnPrev">‚èÆÔ∏è</button>
          <button id="btnPlay">‚ñ∂</button>
          <button id="btnNext">‚è≠Ô∏è</button>
          <label>Seg/pto</label>
          <input id="speed" type="number" min="0.5" step="0.5" value="1.5" style="width:70px" />
        </div>
        <div class="row"><span class="muted" id="nowInfo">‚Äî</span></div>
      </div>

      <!-- Controles para FOTO normal -->
      <div id="controlsPhoto" style="display:none">
        <div class="row">
          <button id="btnZoomIn">Ôºã</button>
          <button id="btnZoomOut">Ôºç</button>
          <button id="btnFit">Ajustar</button>
          <button id="btnOpen">Abrir</button>
        </div>
        <div class="row"><span class="muted">Mostrando imagen no-360</span></div>
      </div>

      <div id="viewerArea">
        <div id="panoContainer"></div>
        <div id="photoContainer"><img id="photoImg" alt="foto" /></div>
      </div>
    </section>
  </div>

  <!-- Badge mini de progreso -->
  <button id="busyBadge" title="Ver detalle de carga">
    <span class="dot"></span><span id="busyText">Cargando‚Ä¶</span>
  </button>

  <!-- Loader / Overlay con progreso -->
  <div id="loading" aria-hidden="true">
    <div class="back"></div>
    <div class="box">
      <div><span class="spinner"></span><b id="loadingTitle">Procesando‚Ä¶</b></div>
      <div id="loadingMsg">Inicializando‚Ä¶</div>
      <div class="progressWrap" aria-hidden="false">
        <div class="progressBar" id="progressBar" style="width:0%"></div>
      </div>
      <div class="loading-actions">
        <button id="btnCancelBusy" class="btn-cancel">Cancelar</button>
        <button id="btnHideBusy" class="ghost">Ocultar</button>
      </div>
    </div>
  </div>

  <!-- Uploader modal -->
  <div id="uploaderModal" class="modal" aria-hidden="true">
    <div class="backdrop" data-close></div>
    <div class="content">
      <h3>Subir GRUPO (CSV + ZIP ‚Üí R2)</h3>
      <form id="groupForm">
        <div class="form-row">
          <div>
            <div class="muted">Nombre del grupo</div>
            <input type="text" id="grupo" placeholder="Recorrido AAAA-MM-DD" required>
          </div>
        </div>
        <div class="form-row">
          <div>
            <div class="muted">CSV (debe incluir <code>codigo</code>)</div>
            <input type="file" id="csvFile" accept=".csv,text/csv" required>
          </div>
        </div>
        <div class="form-row">
          <div>
            <div class="muted">ZIP de fotos</div>
            <input type="file" id="zipFile" accept=".zip,application/zip" required>
          </div>
        </div>
        <div class="actions">
          <button type="button" class="ghost" data-close>Cancelar</button>
          <button type="submit" class="pill">Subir</button>
        </div>
      </form>
      <div id="uploaderMsg" class="muted" style="margin-top:6px"></div>
    </div>
  </div>

  <!-- Modal nueva marcaci√≥n -->
  <div id="markModal" class="modal" aria-hidden="true">
    <div class="backdrop" data-close></div>
    <div class="content">
      <h3>Nueva marcaci√≥n</h3>
      <form id="markForm">
        <div class="form-row cols-2">
          <div>
            <div class="muted">Nombre *</div>
            <input type="text" id="mNombre" required>
          </div>
          <div>
            <div class="muted">Tipo de imagen</div>
            <select id="mTipo">
              <option value="">Sin imagen</option>
              <option value="foto">Foto normal</option>
              <option value="360">Foto 360</option>
            </select>
          </div>
        </div>

        <div class="form-row">
          <div>
            <div class="muted">Imagen (opcional)</div>
            <input type="file" id="mFile" accept="image/*">
          </div>
        </div>

        <div class="form-row cols-2">
          <div>
            <div class="muted">Lat *</div>
            <input type="number" id="mLat" required step="any">
          </div>
          <div>
            <div class="muted">Lng *</div>
            <input type="number" id="mLng" required step="any">
          </div>
        </div>

        <div class="form-row">
          <div>
            <div class="muted">Descripci√≥n</div>
            <textarea id="mDesc" placeholder="Opcional"></textarea>
          </div>
        </div>

        <div class="actions">
          <button type="button" class="ghost" data-close>Cancelar</button>
          <button type="submit" class="pill">Guardar</button>
        </div>
      </form>
      <div id="markMsg" class="muted" style="margin-top:6px"></div>
    </div>
  </div>

  <!-- Modal editar marcaci√≥n -->
  <div id="editMarkModal" class="modal" aria-hidden="true">
    <div class="backdrop" data-close></div>
    <div class="content">
      <h3>Editar marcaci√≥n</h3>
      <form id="editMarkForm">
        <input type="hidden" id="emId">

        <div class="form-row cols-2">
          <div>
            <div class="muted">Nombre *</div>
            <input type="text" id="emNombre" required>
          </div>
          <div>
            <div class="muted">Tipo de imagen</div>
            <select id="emTipo">
              <option value="">Sin imagen</option>
              <option value="foto">Foto normal</option>
              <option value="360">Foto 360</option>
            </select>
          </div>
        </div>

        <div class="form-row">
          <div>
            <div class="muted">Imagen actual</div>
            <div id="emPreview" class="muted">‚Äî</div>
          </div>
        </div>

        <div class="form-row">
          <div>
            <div class="muted">Nueva imagen (opcional)</div>
            <input type="file" id="emFile" accept="image/*">
            <label style="display:flex;gap:6px;align-items:center;margin-top:6px;">
              <input type="checkbox" id="emRemove"> Eliminar imagen actual
            </label>
          </div>
        </div>

        <div class="form-row">
          <div>
            <div class="muted">Descripci√≥n</div>
            <textarea id="emDesc"></textarea>
          </div>
        </div>

        <div class="actions">
          <button type="button" class="ghost" data-close>Cancelar</button>
          <button type="submit" class="pill">Guardar</button>
        </div>
      </form>
      <div id="editMarkMsg" class="muted" style="margin-top:6px"></div>
    </div>
  </div>

  <!-- Modal editar recorrido -->
  <div id="editRecModal" class="modal" aria-hidden="true">
    <div class="backdrop" data-close></div>
    <div class="content">
      <h3>Editar punto de recorrido</h3>
      <form id="editRecForm">
        <input type="hidden" id="erId">
        <div class="form-row cols-2">
          <div><div class="muted">Progresiva</div><input type="text" id="erProg"></div>
          <div><div class="muted">Descripci√≥n</div><input type="text" id="erDesc" placeholder="Opcional"></div>
        </div>
        <div class="actions">
          <button type="button" class="ghost" data-close>Cancelar</button>
          <button type="submit" class="pill">Guardar</button>
        </div>
      </form>
      <div id="editRecMsg" class="muted" style="margin-top:6px"></div>
    </div>
  </div>

  <!-- JS de librer√≠as -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin></script>
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/pannellum@2.5.6/build/pannellum.js"></script>

  <!-- Tu JS -->
  <script src="app.js"></script>
</body>
</html>
