<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Geoportal ‚Äî Recorrido (CSV+ZIP‚ÜíR2) + Loader + Visor 360 (Pannellum)</title>

  <!-- Preconnect al Worker (mejora TTFB del proxy /raw) -->
  <link rel="preconnect" href="https://geoportal-r2-uploader.ilanbailonbruna.workers.dev" crossorigin>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin></script>

  <!-- Supabase JS v2 -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

  <!-- PapaParse (CSV) -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <!-- JSZip (ZIP de fotos) -->
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>

  <!-- ‚úÖ Pannellum (visor 360 ligero, sin Three.js) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pannellum@2.5.6/build/pannellum.css">
  <script src="https://cdn.jsdelivr.net/npm/pannellum@2.5.6/build/pannellum.js"></script>

  <style>
    html, body { height: 100%; margin: 0; }
    body { font-family: system-ui, Arial, sans-serif; }
    #app { height: 100%; display: grid; grid-template-rows: auto 1fr; }
    header { padding: 8px 12px; background:#0f172a; color:#fff; display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    header b { color:#a7f3d0; }
    #map { height: calc(100vh - 60px); }
    .status { margin-left:auto; font-size:12px; opacity:.9; }
    button, input[type="text"], input[type="number"], select { padding:6px 10px; border-radius:8px; border:1px solid #e5e7eb; }
    button { cursor:pointer; background:#111827; color:#fff; border-color:#111827; }
    .pill { background:#0ea5e9; color:#042f2e; border:none; }
    .ghost { background:#0f172a; color:#fff; border:1px solid #334155; }
    #layersInfo { position:absolute; top:66px; left:12px; z-index:1000; background:#fff; padding:6px 10px; border-radius:10px; box-shadow:0 2px 10px rgba(0,0,0,.08); font-size:12px; }

    /* Paneles laterales */
    aside.panel { position:absolute; top:70px; background:#fff; border-radius:12px; box-shadow:0 6px 24px rgba(0,0,0,.15); padding:12px; display:none; z-index:1001; }
    #gallery { right:10px; width:320px; max-height:80vh; overflow:auto; }
    #recorrido { left:10px; width:340px; max-height:80vh; overflow:auto; }
    #uploader { left:10px; top:70px; width:360px; max-height:80vh; overflow:auto; }

    #gallery h3, #recorrido h3 { margin:0 0 8px; font-size:14px; }
    .thumb { width:100%; height:auto; border-radius:8px; margin-bottom:10px; }
    .gallery-item { margin-bottom:14px; border:1px solid #e5e7eb; border-radius:10px; padding:8px }
    .muted { color:#6b7280; font-size:12px }

    .row { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .chip { display:inline-block; padding:2px 8px; border-radius:999px; background:#e5e7eb; font-size:12px; }
    .pulse { box-shadow: 0 0 0 rgba(14,165,233, 0.7); animation: pulse 1.5s infinite; }
    @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(14,165,233, 0.7); } 70% { box-shadow: 0 0 0 20px rgba(14,165,233, 0); } 100% { box-shadow: 0 0 0 0 rgba(14,165,233, 0); } }

    /* Form uploader */
    .mb-2 { margin-bottom:10px; }
    .mb-3 { margin-bottom:14px; }
    .form-label { font-size:12px; color:#374151; display:block; margin-bottom:4px; }
    .form-control, .form-select { width:100%; padding:8px; border:1px solid #e5e7eb; border-radius:8px; }
    .form-actions { display:flex; gap:8px; justify-content:flex-end; }

    /* Loader overlay */
    #loading { position:fixed; inset:0; background:rgba(15,23,42,.7); color:#fff; display:none; align-items:center; justify-content:center; z-index:2000; }
    #loading .box { background:#0b1220; border:1px solid #334155; padding:16px 18px; border-radius:12px; min-width:260px; text-align:center; }
    .spinner { width:38px; height:38px; border-radius:50%; border:4px solid rgba(255,255,255,.25); border-top-color:#fff; margin:0 auto 10px; animation:spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* Visor 360 (panel grande) */
    #viewer360 { right:0; width:75vw; height:calc(100vh - 60px); display:none; }
    #viewer360 .hdr { display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:8px; }
    #viewer360 .hdr .title { font-size:14px; font-weight:600; }
    #pnlmContainer { width:100%; height:calc(100% - 40px); background:#000; border-radius:10px; overflow:hidden; }
  </style>
</head>
<body>
  <div id="app">
    <header>
      <div><b>Leaflet</b> + <b>Supabase</b> + <b>R2</b> ¬∑ CSV+ZIP (formulario), Recorrido & Visor 360 (Pannellum)</div>
      <button id="btnOpenUploader" class="pill">üì¶ Subir GRUPO</button>
      <button id="btnRecorrido" class="ghost">‚ñ∂ Recorrido</button>
      <button id="btnViewer" class="ghost">üï∂Ô∏è 360</button>
      <button id="btnToggleGallery" class="ghost">üñºÔ∏è Galer√≠a</button>
      <input id="search" type="text" placeholder="Filtrar por progresiva‚Ä¶ (Enter)" />
      <div class="status" id="status">Listo</div>
    </header>

    <!-- Loader overlay -->
    <div id="loading"><div class="box">
      <div class="spinner"></div>
      <div id="loadingMsg">Procesando‚Ä¶</div>
    </div></div>

    <!-- Panel FORMULARIO -->
    <aside id="uploader" class="panel">
      <h3>Subir GRUPO (CSV + ZIP ‚Üí R2)</h3>
      <form id="groupForm">
        <div class="mb-3">
          <label class="form-label">Nombre del grupo</label>
          <input type="text" id="grupo" class="form-control" placeholder="Recorrido 2025-09-24" required>
        </div>
        <div class="mb-3">
          <label class="form-label">Campo clave (para fotos)</label>
          <select id="keyField" class="form-select" required>
            <option value="codigo">codigo</option>
            <option value="progresiva">progresiva</option>
          </select>
        </div>
        <div class="mb-3">
          <label class="form-label">Archivo CSV</label>
          <input type="file" id="csvFile" class="form-control" accept=".csv,text/csv" required>
        </div>
        <div class="mb-3">
          <label class="form-label">Archivo ZIP de fotos</label>
          <input type="file" id="zipFile" class="form-control" accept=".zip,application/zip" required>
        </div>
        <div class="form-actions">
          <button type="button" id="btnCloseUploader" class="ghost">Cancelar</button>
          <button type="submit" class="pill">Subir</button>
        </div>
      </form>
      <div id="uploaderMsg" class="muted" style="margin-top:6px"></div>
    </aside>

    <!-- Panel RECORRIDO -->
    <aside id="recorrido" class="panel">
      <h3>Recorrido por <code>numero</code></h3>
      <div class="row mb-2">
        <label>Grupo</label>
        <select id="selGrupo" class="form-select" style="width:auto"></select>
        <span class="chip" id="countPts">0 pts</span>
      </div>
      <div class="row mb-2">
        <button id="btnPrev">‚èÆÔ∏è</button>
        <button id="btnPlay">‚ñ∂</button>
        <button id="btnNext">‚è≠Ô∏è</button>
        <label>Seg/pto</label>
        <input id="speed" type="number" min="0.5" step="0.5" value="2" style="width:70px" />
        <label><input type="checkbox" id="chkLine" checked /> L√≠nea</label>
        <label><input type="checkbox" id="chkLoop" checked /> Loop</label>
      </div>
      <div class="row">
        <div id="nowInfo" class="muted">‚Äî</div>
      </div>
    </aside>

    <!-- Panel VISOR 360 (75% ancho) -->
    <aside id="viewer360" class="panel">
      <div class="hdr">
        <div class="title" id="viewerTitle">Visor 360</div>
        <div class="row">
          <button id="btnCloseViewer" class="ghost">Cerrar</button>
        </div>
      </div>
      <div id="pnlmContainer"></div>
    </aside>

    <!-- Panel GALER√çA -->
    <aside id="gallery" class="panel"></aside>

    <div id="map"></div>
    <div id="layersInfo" style="display:none"></div>
  </div>

  <script>
    // === 1) CONEXI√ìN SUPABASE ===
    const SUPABASE_URL = 'https://vupofyzkwyaejismuzfn.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ1cG9meXprd3lhZWppc211emZuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg2MjUyOTEsImV4cCI6MjA3NDIwMTI5MX0.ITQUUW5CxLROoUiZkO5Hx-u5xtBRSF1UsSJW7RWhLZA';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // === 1.1) R2 Worker URL ===
    const R2_UPLOADER_URL = 'https://geoportal-r2-uploader.ilanbailonbruna.workers.dev';

    // === 2) MAPA + BASEMAPS ===
    const map = L.map('map', { zoomControl: true }).setView([-14.10, -70.44], 13);
    const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 21, attribution: '&copy; OpenStreetMap'});
    const sat = L.tileLayer('https://mt1.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', { maxZoom: 21, attribution: 'Imagery &copy; Google'});
    const hib = L.tileLayer('https://mt1.google.com/vt/lyrs=y&x={x}&y={y}&z={z}', { maxZoom: 21, attribution: 'Map data &copy; Google'}).addTo(map);
    const black = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}.png', { maxZoom: 21, attribution: '&copy; OSM, &copy; CARTO'});

    const layersByGroup = new Map();
    const overlays = {};
    const markerById = new Map();

    const marcacionesLayer = L.layerGroup().addTo(map);
    overlays['Marcaciones (click)'] = marcacionesLayer;

    const baseLayers = { 'Google H√≠brido': hib, 'Google Sat√©lite': sat, 'OSM': osm, 'Carto Dark': black };
    const layersControl = L.control.layers(baseLayers, overlays, { collapsed: false }).addTo(map);

    const statusEl = document.getElementById('status');
    function setStatus(t){ statusEl.textContent = t; clearTimeout(setStatus._t); setStatus._t = setTimeout(()=>statusEl.textContent='Listo', 3500); }

    // Loader helpers
    const loading = document.getElementById('loading');
    const loadingMsg = document.getElementById('loadingMsg');
    function showLoading(msg){ loadingMsg.textContent = msg || 'Procesando‚Ä¶'; loading.style.display='flex'; }
    function setLoading(msg){ loadingMsg.textContent = msg || 'Procesando‚Ä¶'; }
    function hideLoading(){ loading.style.display='none'; }

    function ensureGroupLayer(grupo){
      const name = grupo ?? 'Sin grupo';
      if(!layersByGroup.has(name)){
        const lg = L.layerGroup().addTo(map);
        layersByGroup.set(name, lg);
        overlays[name] = lg;
        layersControl.addOverlay(lg, name);
        updateLayersInfo();
      }
      return layersByGroup.get(name);
    }

    function updateLayersInfo(){
      const el = document.getElementById('layersInfo');
      const names = Array.from(layersByGroup.keys());
      if(!names.length){ el.style.display='none'; return; }
      el.style.display='block';
      el.textContent = 'Capas (grupos): ' + names.join(', ');
    }

    function addFotoMarker(row){
      const lat = Number(row.norte ?? row.lat);
      const lng = Number(row.este ?? row.lng);
      if(!Number.isFinite(lat) || !Number.isFinite(lng)) return;
      const name = row.grupo ?? 'Sin grupo';
      const lg = ensureGroupLayer(name);
      const m = L.marker([lat, lng]).bindPopup(
        `<b>${esc(row.progresiva ?? row.codigo ?? 'Sin etiqueta')}</b>`+
        `<br><small>#${row.numero ?? '-'} ¬∑ Grupo: ${esc(name)} ¬∑ id: ${row.id}</small>`+
        `<br><small>lat/lng: ${lat.toFixed(6)}, ${lng.toFixed(6)}</small>`
      );
      m.addTo(lg);
      markerById.set(row.id, m);
      return m;
    }

    function addMarcacionMarker(row){
      const lat = Number(row.lat);
      const lng = Number(row.lng);
      if(!Number.isFinite(lat) || !Number.isFinite(lng)) return;
      const m = L.marker([lat, lng]).bindPopup(
        `<b>${esc(row.nombre ?? 'Sin nombre')}</b>`+
        (row.descripcion? `<br>${esc(row.descripcion)}`:'' )+
        `<br><small>id: ${row.id} ¬∑ lat/lng: ${lat.toFixed(6)}, ${lng.toFixed(6)}</small>`
      );
      m.addTo(marcacionesLayer);
      return m;
    }

    // Datos de recorrido
    let groupTracks = new Map(); // nombreGrupo -> [{id,numero,este,norte,...}] ordenados
    let routeLayer = null;       // polyline del grupo activo

    async function loadFotos(filterText){
      setStatus('Cargando grupos‚Ä¶');
      for (const lg of layersByGroup.values()) lg.clearLayers();
      markerById.clear();
      let q = supabase.from('fotos_recorrido').select('id,numero,progresiva,codigo,este,norte,grupo,foto_url').order('id');
      if (filterText && filterText.trim()) q = q.ilike('progresiva', `%${filterText.trim()}%`);
      const { data, error } = await q;
      if(error){ console.error(error); setStatus('Error cargando grupos'); return; }

      groupTracks = new Map();
      const bounds = L.latLngBounds();
      let count = 0;
      for(const row of data){
        const m = addFotoMarker(row); if(m){ bounds.extend(m.getLatLng()); count++; }
        const g = row.grupo ?? 'Sin grupo';
        if(!groupTracks.has(g)) groupTracks.set(g, []);
        groupTracks.get(g).push(row);
      }
      for(const [g, arr] of groupTracks){
        arr.sort((a,b)=>{
          const na = (a.numero==null?Infinity:Number(a.numero));
          const nb = (b.numero==null?Infinity:Number(b.numero));
          if (Number.isFinite(na) && Number.isFinite(nb) && na!==nb) return na-nb;
          return a.id - b.id;
        });
      }

      const sel = document.getElementById('selGrupo');
      sel.innerHTML = '';
      for(const g of groupTracks.keys()){
        const opt = document.createElement('option');
        opt.value = g; opt.textContent = g; sel.appendChild(opt);
      }
      if (sel.options.length) sel.value = sel.options[0].value;
      updateCountPts();

      if (count>0) map.fitBounds(bounds.pad(0.2));
      setStatus(`Grupos cargados: ${count} punto(s)`);
      renderGallery();
    }

    function updateCountPts(){
      const g = document.getElementById('selGrupo').value;
      const n = groupTracks.get(g)?.length || 0;
      document.getElementById('countPts').textContent = `${n} pts`;
    }

    async function loadMarcaciones(){
      setStatus('Cargando marcaciones‚Ä¶');
      marcacionesLayer.clearLayers();
      const { data, error } = await supabase.from('marcaciones').select('id,nombre,descripcion,lat,lng,created_at').order('id');
      if(error){ console.error(error); setStatus('Error cargando marcaciones'); return; }
      for(const row of data){ addMarcacionMarker(row); }
      setStatus(`Marcaciones cargadas: ${data.length}`);
    }

    // === FORMULARIO: Apertura/Cierre ===
    const uploader = document.getElementById('uploader');
    document.getElementById('btnOpenUploader').addEventListener('click', ()=>{ uploader.style.display='block'; });
    document.getElementById('btnCloseUploader').addEventListener('click', ()=>{ uploader.style.display='none'; clearForm(); });

    // === FORMULARIO: Env√≠o (CSV + ZIP) ===
    document.getElementById('groupForm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const grupo = document.getElementById('grupo').value.trim();
      const keyField = document.getElementById('keyField').value.trim();
      const csvFile = document.getElementById('csvFile').files[0];
      const zipFile = document.getElementById('zipFile').files[0];
      const msg = document.getElementById('uploaderMsg');
      msg.textContent = '';
      if(!grupo || !keyField || !csvFile || !zipFile){ msg.textContent = 'Completa todos los campos.'; return; }
      try{
        showLoading('Leyendo CSV‚Ä¶');
        const parsed = await new Promise((resolve, reject)=>{ Papa.parse(csvFile, { header:true, skipEmptyLines:'greedy', encoding:'UTF-8', complete: resolve, error: reject }); });
        if(!parsed?.data?.length) throw new Error('CSV vac√≠o o sin encabezados');
        setLoading('Preparando registros‚Ä¶');
        await uploadGroupCsvAndZip(grupo, keyField, parsed.data, zipFile);
        setLoading('Actualizando mapa‚Ä¶');
        await loadFotos();
        hideLoading();
        msg.textContent = '‚úÖ Grupo cargado correctamente';
        uploader.style.display='none';
        clearForm();
      }catch(err){ console.error(err); hideLoading(); msg.textContent = 'Error: '+err.message; }
    });

    function clearForm(){
      document.getElementById('grupo').value = '';
      document.getElementById('keyField').value = 'codigo';
      document.getElementById('csvFile').value = '';
      document.getElementById('zipFile').value = '';
    }

    // === SUBIDA Y VINCULACI√ìN ===
    function normKey(s){ return String(s||'').trim().toLowerCase().replace(/\.[^.]+$/, ''); }

    async function uploadGroupCsvAndZip(grupo, keyField, rowsCsv, zipFile){
      const latKey = detectField(rowsCsv[0], ['y','norte','lat','latitude','latitud']);
      const lngKey = detectField(rowsCsv[0], ['x','este','lng','lon','long','longitud']);
      const progKey = detectField(rowsCsv[0], ['progresiva','pk','progr']);
      const codeKey = detectField(rowsCsv[0], ['codigo','code','filename','foto','image']);
      const numKey  = detectField(rowsCsv[0], ['numero','orden','order','seq','indice','index']);
      if(!latKey || !lngKey) throw new Error('No se detectaron columnas lat/lng (x/y).');
      const toInsert = [];
      for(const r of rowsCsv){
        const lat = toNumberFlexible(r[latKey]);
        const lng = toNumberFlexible(r[lngKey]);
        if(!Number.isFinite(lat) || !Number.isFinite(lng) || lat<-90 || lat>90 || lng<-180 || lng>180) continue;
        const ewkt = `SRID=4326;POINT(${lng} ${lat})`;
        const item = { geom: ewkt, este: lng, norte: lat, grupo };
        if (progKey && r[progKey] != null && r[progKey] !== '') item.progresiva = String(r[progKey]);
        if (codeKey && r[codeKey] != null && r[codeKey] !== '') item.codigo = String(r[codeKey]);
        if (numKey  && r[numKey]  != null && r[numKey]  !== '') item.numero = Number(r[numKey]);
        toInsert.push(item);
      }
      if(!toInsert.length) throw new Error('No hay filas v√°lidas para insertar.');

      setLoading(`Insertando ${toInsert.length} puntos‚Ä¶`);
      const inserted = await insertCsvBatchReturn(toInsert);

      const effectiveKey = keyField || (codeKey || progKey);
      const idsByKey = new Map();
      for(const row of inserted){
        const k = normKey(row[effectiveKey] ?? row.codigo ?? row.progresiva);
        if(!k) continue; if(!idsByKey.has(k)) idsByKey.set(k, []); idsByKey.get(k).push(row.id);
      }

      setLoading('Leyendo ZIP de fotos‚Ä¶');
      const zip = await JSZip.loadAsync(zipFile);
      const entries = Object.values(zip.files).filter(f=>!f.dir);
      if(!entries.length) throw new Error('ZIP vac√≠o');
      const folder = `grupos/${sanitizePath(grupo)}`;
      let ok=0, skip=0, upErr=0; const used = new Map();

      for(let i=0; i<entries.length; i++){
        const f = entries[i];
        if (i % 8 === 0) setLoading(`Subiendo fotos‚Ä¶ ${i+1}/${entries.length}`);
        const base = f.name.split('/').pop();
        const keyNorm = normKey(base);
        const list = idsByKey.get(keyNorm) || [];
        const u = used.get(keyNorm)||0;
        const rowId = list[u];
        if(!rowId){ skip++; continue; }

        const blob = await f.async('blob');
        const ext = (base.match(/\.[^.]+$/)?.[0] || '.jpg').toLowerCase();
        const keyPath = `${folder}/${rowId}_${Date.now()}${ext}`;
        try{
          const fileForForm = new File([blob], base, { type: blob.type||'image/jpeg' });
          const { url, key } = await uploadToR2(R2_UPLOADER_URL, keyPath, fileForForm);
          await updateFotoUrl(rowId, url, key);
          used.set(keyNorm, u+1);
          ok++;
        }catch(e){ upErr++; }
      }
      setLoading(`ZIP procesado ‚Üí vinculadas: ${ok} ¬∑ sin match: ${skip} ¬∑ errores: ${upErr}`);
    }

    async function insertCsvBatchReturn(rows){
      const url = SUPABASE_URL.replace(/\/$/, '') + '/rest/v1/fotos_recorrido?select=id,progresiva,codigo,numero';
      const res = await fetch(url, {
        method: 'POST',
        headers: { 'apikey': SUPABASE_ANON_KEY, 'Authorization': `Bearer ${SUPABASE_ANON_KEY}`, 'Content-Type': 'application/json', 'Prefer': 'return=representation' },
        body: JSON.stringify(rows)
      });
      if(!res.ok){ const t = await res.text(); throw new Error(`Insert CSV HTTP ${res.status}: ${t}`); }
      return res.json();
    }

    async function uploadToR2(workerUrl, keyPath, file){
      const form = new FormData(); form.append('key', keyPath); form.append('file', file, file.name||'file');
      const res = await fetch(workerUrl.replace(/\/$/, '') + '/upload', { method: 'POST', body: form });
      if(!res.ok){ const t=await res.text(); throw new Error(`R2 upload HTTP ${res.status}: ${t}`); }
      return res.json();
    }

    async function updateFotoUrl(rowId, url, key){
      const endpoint = SUPABASE_URL.replace(/\/$/, '') + '/rest/v1/fotos_recorrido?id=eq.'+encodeURIComponent(rowId);
      const res = await fetch(endpoint, {
        method: 'PATCH',
        headers: { 'apikey': SUPABASE_ANON_KEY, 'Authorization': `Bearer ${SUPABASE_ANON_KEY}`, 'Content-Type': 'application/json', 'Prefer': 'return=minimal' },
        body: JSON.stringify({ foto_url: url, foto_r2_key: key })
      });
      if(!res.ok){ const t=await res.text(); throw new Error(`Update foto_url HTTP ${res.status}: ${t}`); }
    }

    // === Player Recorrido ===
    let playTimer = null; let playIdx = 0; let lastHighlight = null;
    document.getElementById('btnRecorrido').addEventListener('click', ()=>{ togglePanel('recorrido'); drawRoute(); });
    document.getElementById('selGrupo').addEventListener('change', ()=>{ stopPlay(); drawRoute(); updateCountPts(); playIdx = 0; updateNowInfo(); });
    document.getElementById('btnPrev').addEventListener('click', ()=>{ step(-1, true); });
    document.getElementById('btnNext').addEventListener('click', ()=>{ step(+1, true); });
    document.getElementById('btnPlay').addEventListener('click', ()=>{ if(playTimer) stopPlay(); else startPlay(); });

    // === Visor 360 (Pannellum) ===
    document.getElementById('btnViewer').addEventListener('click', ()=>{ togglePanel('viewer360'); openViewerPanel(); });
    document.getElementById('btnCloseViewer').addEventListener('click', ()=>{ document.getElementById('viewer360').style.display='none'; });

    let pnlm = null;
    function openViewerPanel(){
      const panel = document.getElementById('viewer360');
      if (getComputedStyle(panel).display === 'none') panel.style.display = 'block';
    }

    async function setViewerImage(rawUrl, caption){
      if(!rawUrl) return;

      // Proxy con CORS OK desde el Worker
      const base = R2_UPLOADER_URL.replace(/\/$/, '');
      const proxied = `${base}/raw?url=${encodeURIComponent(rawUrl)}`;

      document.getElementById('viewerTitle').textContent = caption || 'Visor 360';
      openViewerPanel();

      // Recrear el visor para cargar nuevo panorama limpio
      try { if (pnlm && pnlm.destroy) pnlm.destroy(); } catch(e) {}
      pnlm = null;

      try {
        pnlm = pannellum.viewer('pnlmContainer', {
          type: 'equirectangular',
          panorama: proxied,
          autoLoad: true,
          showZoomCtrl: true,
          compass: false,
          // l√≠mites de FOV razonables (mejor UX m√≥vil)
          hfov: 100,
          minHfov: 50,
          maxHfov: 120,
        });
      } catch (err) {
        console.error('Pannellum error:', err);
        alert(
          'No se pudo cargar el 360.\n\nRevisa:\n' +
          '‚Ä¢ CORS del bucket/worker (usa /raw)\n' +
          '‚Ä¢ Que la imagen sea equirectangular 2:1\n' +
          '‚Ä¢ Tama√±o del archivo'
        );
      }
    }

    function startPlay(){ if(playTimer) return; showAt(playIdx, true); const interval = Math.max(500, Number(document.getElementById('speed').value)*1000); playTimer = setInterval(()=>step(+1,false), interval); document.getElementById('btnPlay').textContent = '‚è∏Ô∏è'; }
    function stopPlay(){ if(playTimer){ clearInterval(playTimer); playTimer=null; document.getElementById('btnPlay').textContent = '‚ñ∂'; } }

    function step(delta, manual){
      const g = document.getElementById('selGrupo').value; const arr = groupTracks.get(g)||[]; if(!arr.length){ stopPlay(); return; }
      playIdx += delta;
      if (playIdx >= arr.length){ if(document.getElementById('chkLoop').checked){ playIdx = 0; } else { stopPlay(); playIdx = arr.length-1; } }
      if (playIdx < 0){ if(document.getElementById('chkLoop').checked){ playIdx = arr.length-1; } else { playIdx = 0; } }
      showAt(playIdx, manual);
    }

    function showAt(i, openPopup){
      const g = document.getElementById('selGrupo').value; const arr = groupTracks.get(g)||[]; if(!arr.length) return;
      const row = arr[i]; if(!row) return; const m = markerById.get(row.id); if(!m) return;
      map.panTo(m.getLatLng());
      const viewerOpen = document.getElementById('viewer360').style.display==='block';
      if (openPopup && !viewerOpen) m.openPopup();
      if (lastHighlight){ lastHighlight._icon?.classList.remove('pulse'); }
      if (m._icon){ m._icon.classList.add('pulse'); lastHighlight = m; }
      playIdx = i; updateNowInfo(row, i, arr.length);
      if (row.foto_url){
        const cap = `#${row.numero ?? (i+1)} ¬∑ ${row.progresiva || row.codigo || ''}`;
        setViewerImage(row.foto_url, cap);
      }
    }

    function updateNowInfo(row, i, total){
      const el = document.getElementById('nowInfo');
      if(!row){ el.textContent = '‚Äî'; return; }
      el.innerHTML = `#${row.numero ?? (i+1)} ¬∑ ${esc(row.progresiva || row.codigo || '')} ¬∑ <span class="muted">(${i+1}/${total})</span>`;
    }

    function drawRoute(){
      if(routeLayer){ routeLayer.remove(); routeLayer=null; }
      if(!document.getElementById('chkLine').checked) return;
      const g = document.getElementById('selGrupo').value; const arr = groupTracks.get(g)||[]; if(!arr.length) return;
      const latlngs = arr.map(r=>[Number(r.norte), Number(r.este)]).filter(([a,b])=>Number.isFinite(a)&&Number.isFinite(b));
      if(latlngs.length>=2){ routeLayer = L.polyline(latlngs, { weight: 3, opacity: .9 }).addTo(map); map.fitBounds(routeLayer.getBounds().pad(0.2)); }
    }

    // === B√∫squeda y Galer√≠a ===
    document.getElementById('search').addEventListener('keydown', (e)=>{ if(e.key==='Enter') loadFotos(e.target.value); });
    document.getElementById('btnToggleGallery').addEventListener('click', ()=>{ togglePanel('gallery'); if(document.getElementById('gallery').style.display==='block') renderGallery(); });

    async function renderGallery(){
      const panel = document.getElementById('gallery');
      const { data, error } = await supabase.from('fotos_recorrido').select('id,progresiva,codigo,grupo,foto_url,numero').not('foto_url','is',null).order('numero', { ascending: true }).limit(400);
      if(error){ panel.innerHTML = '<div class="muted">Error cargando galer√≠a</div>'; return; }
      const items = (data||[]).map(r=>{
        const label = (r.grupo? '['+r.grupo+'] ':'') + (r.progresiva||r.codigo||('id '+r.id));
        const cap = esc('#'+(r.numero??'')+' '+label);
        // Thumbs pueden usar URL directa (no necesitan CORS para <img>)
        const img = `<img class="thumb" loading="lazy" src="${esc(r.foto_url||'')}" alt="${cap}">`;
        return `<div class="gallery-item">${img}<div class="muted">${cap}</div></div>`;
      });
      panel.innerHTML = `<h3>Galer√≠a (ordenada por numero)</h3>` + (items.join('') || '<div class="muted">Sin fotos</div>');
    }

    function togglePanel(id){
      const el = document.getElementById(id);
      const visible = el.style.display==='block';
      document.querySelectorAll('aside.panel').forEach(p=>p.style.display='none');
      el.style.display = visible ? 'none' : 'block';
    }

    // === utils ===
    function detectField(obj, candidates){ const keys = Object.keys(obj||{}); for(const c of candidates){ const k = keys.find(k=>k.toLowerCase()===c.toLowerCase()); if(k) return k; } for(const c of candidates){ const k = keys.find(k=>k.toLowerCase().includes(c.toLowerCase())); if(k) return k; } return null; }
    function toNumberFlexible(v){ if (v===null || v===undefined) return NaN; if (typeof v === 'number') return v; if (typeof v !== 'string') return NaN; const s = v.trim().replace(/\s+/g,''); const s2 = s.replace(',', '.'); const n = parseFloat(s2); return Number.isFinite(n) ? n : NaN; }
    function sanitizePath(s){ return String(s||'').normalize('NFKD').replace(/[^a-zA-Z0-9_\-\/\.]+/g,'-').replace(/--+/g,'-').replace(/^-+|-+$/g,''); }
    function esc(s){ return String(s).replace(/[&<>"']/g, c=>({"&":"&amp;","<":"&lt;"," >":"&gt;","\"":"&quot;","'":"&#39;"}[c])); }

    // === Inicio ===
    (async () => { await loadFotos(); await loadMarcaciones(); })();
  </script>
</body>
</html>
