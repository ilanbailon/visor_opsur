# visor_opsur

## Adjuntos para marcaciones

El visor ahora permite subir archivos adjuntos (PDF, Excel, DOCX, etc.) por cada marcación. Los adjuntos se guardan en una carpeta `adjuntos/` dentro del bucket de R2 y comparten la misma lógica de acceso que las fotografías: el worker de Cloudflare entrega los archivos a través de `/raw-public/<key>` cuando existe un `archivo_r2_key`, o recurre al proxy `/raw?url=…` cuando solo se almacena la URL.

### Requisitos en la base de datos (Supabase)

Crea la tabla `marcacion_adjuntos` con la siguiente estructura (ajusta el esquema si no usas `public`). Puedes ejecutar el
script `sql/marcacion_adjuntos.sql` directamente desde la consola SQL de Supabase o cualquier cliente Postgres:

```sql
create table public.marcacion_adjuntos (
  id              bigint generated by default as identity primary key,
  marcacion_id    bigint not null references public.marcaciones(id) on delete cascade,
  nombre          text,
  archivo_url     text,
  archivo_r2_key  text,
  mime_type       text,
  created_at      timestamptz not null default timezone('utc', now())
);

create index on public.marcacion_adjuntos (marcacion_id);
```

Si tienes RLS activo, replica para esta tabla las mismas políticas que utilizas en `marcaciones` para lectura/escritura mediante la clave anónima.

### Estructura en R2

Los adjuntos se suben con claves del tipo:

```
adjuntos/<ID_MARCACION>/<timestamp>_<indice>_<nombre-sanitizado>.<ext>
```

No es necesario crear buckets adicionales; basta con que el worker tenga permisos de escritura/lectura sobre la carpeta `adjuntos/`.

## Flujo de uso

1. Al crear o editar una marcación puedes seleccionar varios archivos adjuntos desde el modal.
2. Cada archivo se sube a R2 y se registra en `marcacion_adjuntos` con su tipo MIME original.
3. El panel derecho del visor muestra la lista de adjuntos disponibles y permite abrirlos en una pestaña nueva. En la edición se pueden eliminar adjuntos existentes.

## Dependencias

El proyecto es un front-end estático que consume Supabase y el worker de R2; no requiere pasos de build adicionales.
